<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM de Vendas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    .card-glass {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.5);
    }
    .status-novo { background: #3b82f6; }
    .status-contato { background: #f59e0b; }
    .status-negociacao { background: #8b5cf6; }
    .status-fechado { background: #10b981; }
    .status-perdido { background: #ef4444; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .nav-item {
      transition: all 0.2s ease;
    }
    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }
    .nav-item.active {
      background: rgba(59, 130, 246, 0.2);
      border-left: 3px solid #3b82f6;
    }
  </style>
</head>
<body class="h-full gradient-bg text-slate-100 overflow-auto">
  <div id="app" class="h-full flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900/50 border-r border-slate-700/50 flex flex-col flex-shrink-0">
      <div class="p-6 border-b border-slate-700/50">
        <h1 id="company-name" class="text-xl font-bold text-white flex items-center gap-2">
          <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          CRM Vendas
        </h1>
        <p id="welcome-msg" class="text-slate-400 text-sm mt-1">Gerencie suas vendas</p>
      </div>
      
      <nav class="flex-1 p-4 space-y-1">
        <button onclick="showSection('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="dashboard">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
          </svg>
          Dashboard
        </button>
        <button onclick="showSection('leads')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="leads">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
          Leads
        </button>
        <button onclick="showSection('agenda')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="agenda">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Agenda
        </button>
        <button onclick="showSection('historico')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="historico">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Histórico
        </button>
        <button onclick="showSection('importexport')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="importexport">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
          </svg>
          Importar/Exportar
        </button>
        <button onclick="showSection('relatorios')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="relatorios">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Relatórios
        </button>
        <button onclick="showSection('metas')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="metas">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Metas
        </button>
        <button onclick="showSection('lembretes')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left relative" data-section="lembretes">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
          Lembretes
          <span id="reminder-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </button>
      </nav>

      <div class="p-4 border-t border-slate-700/50">
        <div class="card-glass rounded-lg p-4">
          <p class="text-xs text-slate-400 mb-2">Total de Leads</p>
          <p id="sidebar-total-leads" class="text-2xl font-bold text-white">0</p>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-6 scrollbar-thin">
      <!-- Dashboard Section -->
      <section id="section-dashboard" class="animate-fade-in">
        <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="card-glass rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-slate-400 text-sm">Total de Leads</p>
                <p id="stat-total" class="text-3xl font-bold mt-1">0</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="card-glass rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-slate-400 text-sm">Em Negociação</p>
                <p id="stat-negociacao" class="text-3xl font-bold mt-1">0</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="card-glass rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-slate-400 text-sm">Fechados</p>
                <p id="stat-fechados" class="text-3xl font-bold mt-1">0</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
            </div>
          </div>
          
          <div class="card-glass rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-slate-400 text-sm">Valor Total</p>
                <p id="stat-valor" class="text-3xl font-bold mt-1">R$ 0</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Pipeline & Recent Leads -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Pipeline -->
          <div class="lg:col-span-2 card-glass rounded-xl p-5">
            <h3 class="text-lg font-semibold mb-4">Pipeline de Vendas</h3>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-slate-400">Novo</span>
                <div class="flex-1 h-8 bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="pipe-novo" class="h-full status-novo transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pipe-novo-count" class="w-10 text-right text-sm">0</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-slate-400">Contato</span>
                <div class="flex-1 h-8 bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="pipe-contato" class="h-full status-contato transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pipe-contato-count" class="w-10 text-right text-sm">0</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-slate-400">Negociação</span>
                <div class="flex-1 h-8 bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="pipe-negociacao" class="h-full status-negociacao transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pipe-negociacao-count" class="w-10 text-right text-sm">0</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-slate-400">Fechado</span>
                <div class="flex-1 h-8 bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="pipe-fechado" class="h-full status-fechado transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pipe-fechado-count" class="w-10 text-right text-sm">0</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-slate-400">Perdido</span>
                <div class="flex-1 h-8 bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="pipe-perdido" class="h-full status-perdido transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pipe-perdido-count" class="w-10 text-right text-sm">0</span>
              </div>
            </div>
          </div>

          <!-- Recent Leads -->
          <div class="card-glass rounded-xl p-5">
            <h3 class="text-lg font-semibold mb-4">Leads Recentes</h3>
            <div id="recent-leads" class="space-y-3 max-h-64 overflow-y-auto scrollbar-thin">
              <p class="text-slate-400 text-sm">Nenhum lead cadastrado</p>
            </div>
          </div>
        </div>

        <!-- Upcoming Events -->
        <div class="mt-6 card-glass rounded-xl p-5">
          <h3 class="text-lg font-semibold mb-4">Próximos Compromissos</h3>
          <div id="upcoming-events" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <p class="text-slate-400 text-sm">Nenhum compromisso agendado</p>
          </div>
        </div>
      </section>

      <!-- Leads Section -->
      <section id="section-leads" class="hidden animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Gerenciar Leads</h2>
          <button onclick="openLeadModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Novo Lead
          </button>
        </div>

        <!-- Filters -->
        <div class="card-glass rounded-xl p-4 mb-6">
          <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
              <input type="text" id="search-leads" placeholder="Buscar por nome, email ou empresa..." 
                class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500">
            </div>
            <select id="filter-status" class="bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
              <option value="">Todos os Status</option>
              <option value="novo">Novo</option>
              <option value="contato">Contato</option>
              <option value="negociacao">Negociação</option>
              <option value="fechado">Fechado</option>
              <option value="perdido">Perdido</option>
            </select>
            <select id="filter-source" class="bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
              <option value="">Todas as Origens</option>
              <option value="website">Website</option>
              <option value="indicacao">Indicação</option>
              <option value="linkedin">LinkedIn</option>
              <option value="instagram">Instagram</option>
              <option value="facebook">Facebook</option>
              <option value="google">Google Ads</option>
              <option value="outro">Outro</option>
            </select>
          </div>
        </div>

        <!-- Leads Table -->
        <div class="card-glass rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-700/50">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Nome</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Empresa</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Contato</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Status</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Valor</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Origem</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Ações</th>
                </tr>
              </thead>
              <tbody id="leads-table-body" class="divide-y divide-slate-700/50">
                <tr>
                  <td colspan="7" class="px-4 py-8 text-center text-slate-400">Nenhum lead cadastrado. Clique em "Novo Lead" para começar.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Agenda Section -->
      <section id="section-agenda" class="hidden animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Agenda</h2>
          <button onclick="openEventModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Novo Evento
          </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Calendar Mini -->
          <div class="card-glass rounded-xl p-5">
            <div class="flex items-center justify-between mb-4">
              <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <h3 id="calendar-month" class="font-semibold"></h3>
              <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm mb-2">
              <span class="text-slate-400">D</span>
              <span class="text-slate-400">S</span>
              <span class="text-slate-400">T</span>
              <span class="text-slate-400">Q</span>
              <span class="text-slate-400">Q</span>
              <span class="text-slate-400">S</span>
              <span class="text-slate-400">S</span>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
          </div>

          <!-- Events List -->
          <div class="lg:col-span-2 card-glass rounded-xl p-5">
            <h3 class="text-lg font-semibold mb-4">Eventos do Dia: <span id="selected-date" class="text-blue-400"></span></h3>
            <div id="events-list" class="space-y-3 max-h-96 overflow-y-auto scrollbar-thin">
              <p class="text-slate-400 text-sm">Selecione uma data no calendário</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Historico Section -->
      <section id="section-historico" class="hidden animate-fade-in">
        <h2 class="text-2xl font-bold mb-6">Histórico de Atendimentos</h2>
        
        <div class="card-glass rounded-xl p-4 mb-6">
          <div class="flex flex-wrap gap-4">
            <select id="historico-lead-filter" class="flex-1 min-w-[200px] bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
              <option value="">Todos os Leads</option>
            </select>
            <input type="date" id="historico-date-start" class="bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
            <input type="date" id="historico-date-end" class="bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
        </div>

        <div id="historico-timeline" class="space-y-4">
          <div class="card-glass rounded-xl p-6 text-center">
            <p class="text-slate-400">Nenhum histórico encontrado</p>
          </div>
        </div>
      </section>

      <!-- Import/Export Section -->
      <section id="section-importexport" class="hidden animate-fade-in">
        <h2 class="text-2xl font-bold mb-6">Importar / Exportar Leads</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Import -->
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold">Importar Leads</h3>
                <p class="text-slate-400 text-sm">Upload de arquivo Excel (.xlsx)</p>
              </div>
            </div>
            
            <div class="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:border-blue-500 transition-colors cursor-pointer" onclick="document.getElementById('import-file').click()">
              <input type="file" id="import-file" accept=".xlsx,.xls" class="hidden" onchange="importExcel(event)">
              <svg class="w-12 h-12 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <p class="text-slate-300 mb-2">Arraste o arquivo ou clique para selecionar</p>
              <p class="text-slate-500 text-sm">Formato: Excel (.xlsx)</p>
            </div>
            
            <div class="mt-4">
              <button onclick="downloadTemplate()" class="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Baixar modelo de planilha
              </button>
            </div>
            
            <div id="import-status" class="mt-4 hidden">
              <div class="bg-slate-700/50 rounded-lg p-4">
                <p id="import-message" class="text-sm"></p>
              </div>
            </div>
          </div>

          <!-- Export -->
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold">Exportar Leads</h3>
                <p class="text-slate-400 text-sm">Download em Excel (.xlsx)</p>
              </div>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-slate-400 mb-2">Filtrar por Status</label>
                <select id="export-status" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                  <option value="">Todos os Status</option>
                  <option value="novo">Novo</option>
                  <option value="contato">Contato</option>
                  <option value="negociacao">Negociação</option>
                  <option value="fechado">Fechado</option>
                  <option value="perdido">Perdido</option>
                </select>
              </div>
              
              <button onclick="exportExcel()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Exportar para Excel
              </button>
              
              <p id="export-count" class="text-center text-slate-400 text-sm"></p>
            </div>
          </div>
        </div>
      </section>

      <!-- Relatorios Section -->
      <section id="section-relatorios" class="hidden animate-fade-in">
        <h2 class="text-2xl font-bold mb-6">Relatórios</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="card-glass rounded-xl p-6 hover:border-blue-500/50 border border-transparent transition-colors cursor-pointer" onclick="generateReport('geral')">
            <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center mb-4">
              <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">Relatório Geral</h3>
            <p class="text-slate-400 text-sm">Visão completa de todos os leads e métricas do funil de vendas</p>
          </div>
          
          <div class="card-glass rounded-xl p-6 hover:border-green-500/50 border border-transparent transition-colors cursor-pointer" onclick="generateReport('conversao')">
            <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center mb-4">
              <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">Taxa de Conversão</h3>
            <p class="text-slate-400 text-sm">Análise detalhada das taxas de conversão por etapa</p>
          </div>
          
          <div class="card-glass rounded-xl p-6 hover:border-purple-500/50 border border-transparent transition-colors cursor-pointer" onclick="generateReport('origem')">
            <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center mb-4">
              <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">Leads por Origem</h3>
            <p class="text-slate-400 text-sm">Distribuição de leads por canal de aquisição</p>
          </div>
        </div>

        <div id="report-preview" class="mt-6 hidden">
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 id="report-title" class="text-lg font-semibold"></h3>
              <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Baixar PDF
              </button>
            </div>
            <div id="report-content" class="bg-white text-slate-800 rounded-lg p-6"></div>
          </div>
        </div>
      <!-- Metas Section -->
      <section id="section-metas" class="hidden animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Gerenciar Metas</h2>
          <button onclick="openGoalModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Nova Meta
          </button>
        </div>

        <!-- Meta Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Faturamento -->
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-slate-400 text-sm">Meta de Faturamento</p>
                <p id="goal-revenue-type" class="text-slate-400 text-xs mt-1">Mensal</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
            </div>
            <div class="flex-1 h-2 bg-slate-700/50 rounded-full overflow-hidden mb-3">
              <div id="goal-revenue-progress" class="h-full bg-amber-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between mb-2">
              <span id="goal-revenue-current" class="text-sm text-slate-300">R$ 0</span>
              <span id="goal-revenue-target" class="text-sm text-slate-300">R$ 0</span>
            </div>
            <p id="goal-revenue-percent" class="text-xs text-slate-500 text-center">0% da meta</p>
          </div>

          <!-- Atendimentos -->
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-slate-400 text-sm">Meta de Atendimentos</p>
                <p id="goal-meetings-type" class="text-slate-400 text-xs mt-1">Semanal</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
            </div>
            <div class="flex-1 h-2 bg-slate-700/50 rounded-full overflow-hidden mb-3">
              <div id="goal-meetings-progress" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between mb-2">
              <span id="goal-meetings-current" class="text-sm text-slate-300">0</span>
              <span id="goal-meetings-target" class="text-sm text-slate-300">0</span>
            </div>
            <p id="goal-meetings-percent" class="text-xs text-slate-500 text-center">0% da meta</p>
          </div>

          <!-- Vendas -->
          <div class="card-glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-slate-400 text-sm">Meta de Vendas</p>
                <p id="goal-sales-type" class="text-slate-400 text-xs mt-1">Mensal</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center">
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
            </div>
            <div class="flex-1 h-2 bg-slate-700/50 rounded-full overflow-hidden mb-3">
              <div id="goal-sales-progress" class="h-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-between mb-2">
              <span id="goal-sales-current" class="text-sm text-slate-300">0</span>
              <span id="goal-sales-target" class="text-sm text-slate-300">0</span>
            </div>
            <p id="goal-sales-percent" class="text-xs text-slate-500 text-center">0% da meta</p>
          </div>
        </div>

        <!-- Goals Table -->
        <div class="card-glass rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-700/50">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Tipo de Meta</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Período</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Meta</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Atual</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Progresso</th>
                  <th class="px-4 py-3 text-left text-sm font-medium text-slate-300">Ações</th>
                </tr>
              </thead>
              <tbody id="goals-table-body" class="divide-y divide-slate-700/50">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-slate-400">Nenhuma meta cadastrada. Clique em "Nova Meta" para começar.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Goals Details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
          <!-- Weekly Details -->
          <div class="card-glass rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Metas Semanais</h3>
            <div id="weekly-goals" class="space-y-4">
              <p class="text-slate-400 text-sm">Nenhuma meta semanal</p>
            </div>
          </div>

          <!-- Daily Details -->
          <div class="card-glass rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">Metas Diárias</h3>
            <div id="daily-goals" class="space-y-4">
              <p class="text-slate-400 text-sm">Nenhuma meta diária</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Lembretes Section -->
      <section id="section-lembretes" class="hidden animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Lembretes</h2>
          <button onclick="openReminderModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Novo Lembrete
          </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Active Reminders -->
          <div class="lg:col-span-2">
            <div class="card-glass rounded-xl p-6 mb-6">
              <h3 class="text-lg font-semibold mb-4">Lembretes Pendentes</h3>
              <div id="active-reminders" class="space-y-3">
                <p class="text-slate-400 text-sm">Nenhum lembrete pendente</p>
              </div>
            </div>

            <div class="card-glass rounded-xl p-6">
              <h3 class="text-lg font-semibold mb-4">Todos os Lembretes</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-slate-700/50">
                    <tr>
                      <th class="px-4 py-3 text-left text-slate-300">Título</th>
                      <th class="px-4 py-3 text-left text-slate-300">Data/Hora</th>
                      <th class="px-4 py-3 text-left text-slate-300">Lead</th>
                      <th class="px-4 py-3 text-left text-slate-300">Status</th>
                      <th class="px-4 py-3 text-left text-slate-300">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="reminders-table-body" class="divide-y divide-slate-700/50">
                    <tr>
                      <td colspan="5" class="px-4 py-8 text-center text-slate-400">Nenhum lembrete cadastrado</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card-glass rounded-xl p-6 h-fit">
            <h3 class="text-lg font-semibold mb-4">Filtros</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-slate-400 mb-2">Status</label>
                <select id="reminder-filter-status" onchange="filterReminders()" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                  <option value="">Todos</option>
                  <option value="pendente">Pendentes</option>
                  <option value="concluido">Concluídos</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2">Lead</label>
                <select id="reminder-filter-lead" onchange="filterReminders()" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                  <option value="">Todos</option>
                </select>
              </div>
              <button onclick="clearReminders()" class="w-full bg-slate-700/50 hover:bg-slate-600 px-3 py-2 rounded-lg text-sm transition-colors">
                Limpar Concluídos
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Reminder Modal -->
  <div id="reminder-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="card-glass rounded-2xl w-full max-w-lg">
      <div class="p-6 border-b border-slate-700/50 flex items-center justify-between">
        <h3 id="reminder-modal-title" class="text-xl font-semibold">Novo Lembrete</h3>
        <button onclick="closeReminderModal()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="reminder-form" class="p-6 space-y-4">
        <input type="hidden" id="reminder-id">
        <div>
          <label for="reminder-title" class="block text-sm text-slate-400 mb-1">Título *</label>
          <input type="text" id="reminder-title" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
        </div>
        <div>
          <label for="reminder-description" class="block text-sm text-slate-400 mb-1">Descrição</label>
          <textarea id="reminder-description" rows="2" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 resize-none"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="reminder-date" class="block text-sm text-slate-400 mb-1">Data *</label>
            <input type="date" id="reminder-date" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="reminder-time" class="block text-sm text-slate-400 mb-1">Hora *</label>
            <input type="time" id="reminder-time" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
        </div>
        <div>
          <label for="reminder-lead" class="block text-sm text-slate-400 mb-1">Lead Relacionado</label>
          <select id="reminder-lead" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">Nenhum</option>
          </select>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeReminderModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
          <button type="submit" id="reminder-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">Salvar Lembrete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reminder Notification Popup -->
  <div id="reminder-popup" class="fixed inset-0 flex items-center justify-center z-[60] hidden">
    <div class="bg-black/50 absolute inset-0 backdrop-blur-sm" onclick="closeReminderPopup()"></div>
    <div class="card-glass rounded-2xl w-full max-w-md p-6 shadow-2xl relative animate-fade-in">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
        <div class="flex-1">
          <h3 id="popup-title" class="text-lg font-semibold text-white mb-1">Lembrete</h3>
          <p id="popup-description" class="text-slate-300 text-sm mb-3">Descrição do lembrete</p>
          <p id="popup-lead" class="text-xs text-slate-500 mb-4"></p>
          <div class="flex gap-2">
            <button onclick="markReminderComplete()" class="flex-1 bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg font-medium text-sm transition-colors">
              Concluir
            </button>
            <button onclick="closeReminderPopup()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg font-medium text-sm transition-colors">
              Descartar
            </button>
          </div>
        </div>
        <button onclick="closeReminderPopup()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors absolute top-3 right-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Lead Modal -->
  <div id="lead-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="card-glass rounded-2xl w-full max-w-2xl max-h-[90%] overflow-y-auto scrollbar-thin">
      <div class="p-6 border-b border-slate-700/50 flex items-center justify-between">
        <h3 id="lead-modal-title" class="text-xl font-semibold">Novo Lead</h3>
        <button onclick="closeLeadModal()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="lead-form" class="p-6 space-y-4">
        <input type="hidden" id="lead-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="lead-name" class="block text-sm text-slate-400 mb-1">Nome *</label>
            <input type="text" id="lead-name" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="lead-email" class="block text-sm text-slate-400 mb-1">Email *</label>
            <input type="email" id="lead-email" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="lead-phone" class="block text-sm text-slate-400 mb-1">Telefone</label>
            <input type="tel" id="lead-phone" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="lead-company" class="block text-sm text-slate-400 mb-1">Empresa</label>
            <input type="text" id="lead-company" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="lead-status" class="block text-sm text-slate-400 mb-1">Status</label>
            <select id="lead-status" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
              <option value="novo">Novo</option>
              <option value="contato">Contato</option>
              <option value="negociacao">Negociação</option>
              <option value="fechado">Fechado</option>
              <option value="perdido">Perdido</option>
            </select>
          </div>
          <div>
            <label for="lead-value" class="block text-sm text-slate-400 mb-1">Valor (R$)</label>
            <input type="number" id="lead-value" min="0" step="0.01" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div class="md:col-span-2">
            <label for="lead-source" class="block text-sm text-slate-400 mb-1">Origem</label>
            <select id="lead-source" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
              <option value="website">Website</option>
              <option value="indicacao">Indicação</option>
              <option value="linkedin">LinkedIn</option>
              <option value="instagram">Instagram</option>
              <option value="facebook">Facebook</option>
              <option value="google">Google Ads</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label for="lead-notes" class="block text-sm text-slate-400 mb-1">Observações</label>
            <textarea id="lead-notes" rows="3" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 resize-none"></textarea>
          </div>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeLeadModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
          <button type="button" id="add-reminder-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2" style="display: none;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            Adicionar Lembrete
          </button>
          <button type="submit" id="lead-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">Salvar Lead</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="event-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="card-glass rounded-2xl w-full max-w-lg">
      <div class="p-6 border-b border-slate-700/50 flex items-center justify-between">
        <h3 id="event-modal-title" class="text-xl font-semibold">Novo Evento</h3>
        <button onclick="closeEventModal()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="event-form" class="p-6 space-y-4">
        <input type="hidden" id="event-id">
        <div>
          <label for="event-title" class="block text-sm text-slate-400 mb-1">Título *</label>
          <input type="text" id="event-title" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="event-date" class="block text-sm text-slate-400 mb-1">Data *</label>
            <input type="date" id="event-date" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="event-time" class="block text-sm text-slate-400 mb-1">Hora *</label>
            <input type="time" id="event-time" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
          </div>
        </div>
        <div>
          <label for="event-lead" class="block text-sm text-slate-400 mb-1">Lead Relacionado</label>
          <select id="event-lead" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">Nenhum</option>
          </select>
        </div>
        <div>
          <label for="event-notes" class="block text-sm text-slate-400 mb-1">Descrição</label>
          <textarea id="event-notes" rows="2" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 resize-none"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeEventModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
          <button type="submit" id="event-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">Salvar Evento</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Goal Modal -->
  <div id="goal-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="card-glass rounded-2xl w-full max-w-lg">
      <div class="p-6 border-b border-slate-700/50 flex items-center justify-between">
        <h3 id="goal-modal-title" class="text-xl font-semibold">Nova Meta</h3>
        <button onclick="closeGoalModal()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="goal-form" class="p-6 space-y-4">
        <input type="hidden" id="goal-id">
        <div>
          <label for="goal-type" class="block text-sm text-slate-400 mb-1">Tipo de Meta *</label>
          <select id="goal-type" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">Selecione um tipo</option>
            <option value="faturamento">Faturamento (R$)</option>
            <option value="atendimentos">Atendimentos</option>
            <option value="vendas">Vendas</option>
          </select>
        </div>
        <div>
          <label for="goal-period" class="block text-sm text-slate-400 mb-1">Período *</label>
          <select id="goal-period" required class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">Selecione o período</option>
            <option value="diaria">Diária</option>
            <option value="semanal">Semanal</option>
            <option value="mensal">Mensal</option>
          </select>
        </div>
        <div>
          <label for="goal-target" class="block text-sm text-slate-400 mb-1">Meta *</label>
          <input type="number" id="goal-target" required min="0" step="0.01" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500" placeholder="Digite o valor da meta">
        </div>
        <div class="bg-slate-700/30 rounded-lg p-3 text-sm text-slate-400">
          <p>💡 <strong>Dica:</strong> As metas são calculadas automaticamente baseadas nos seus leads e eventos.</p>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeGoalModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
          <button type="submit" id="goal-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">Salvar Meta</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="card-glass rounded-2xl w-full max-w-md p-6">
      <div class="text-center">
        <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">Confirmar Exclusão</h3>
        <p id="delete-message" class="text-slate-400 mb-6">Tem certeza que deseja excluir este item?</p>
        <div class="flex gap-3">
          <button onclick="closeDeleteModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">Cancelar</button>
          <button id="confirm-delete-btn" onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    // Global state
    let allData = [];
    let leads = [];
    let events = [];
    let reminders = [];
    let currentMonth = new Date();
    let selectedDate = new Date();
    let deleteCallback = null;
    let currentReportType = '';
    let currentReportData = null;
    let currentReminderPopup = null;
    let reminderCheckInterval = null;

    const defaultConfig = {
      company_name: 'CRM Vendas',
      welcome_message: 'Gerencie suas vendas'
    };

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        leads = data.filter(d => d.type === 'lead');
        events = data.filter(d => d.type === 'event');
        reminders = data.filter(d => d.type === 'reminder');
        
        updateDashboard();
        updateLeadsTable();
        updateCalendar();
        updateHistoricoLeadFilter();
        updateEventLeadSelect();
        updateExportCount();
        updateRemindersDisplay();
        checkReminders();
      }
    };

    // Initialize
    async function init() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        showToast('Erro ao inicializar o sistema', 'error');
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('company-name').childNodes[1].textContent = config.company_name || defaultConfig.company_name;
            document.getElementById('welcome-msg').textContent = config.welcome_message || defaultConfig.welcome_message;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['company_name', config.company_name || defaultConfig.company_name],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      // Setup event listeners
      document.getElementById('lead-form').addEventListener('submit', handleLeadSubmit);
      document.getElementById('event-form').addEventListener('submit', handleEventSubmit);
      document.getElementById('search-leads').addEventListener('input', filterLeads);
      document.getElementById('filter-status').addEventListener('change', filterLeads);
      document.getElementById('filter-source').addEventListener('change', filterLeads);
      document.getElementById('historico-lead-filter').addEventListener('change', filterHistorico);
      document.getElementById('historico-date-start').addEventListener('change', filterHistorico);
      document.getElementById('historico-date-end').addEventListener('change', filterHistorico);

      updateCalendar();
    }

    // Navigation
    function showSection(section) {
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`section-${section}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === section) {
          item.classList.add('active');
        }
      });

      if (section === 'historico') {
        renderHistorico();
      }
    }

    // Dashboard
    function updateDashboard() {
      const total = leads.length;
      const negociacao = leads.filter(l => l.status === 'negociacao').length;
      const fechados = leads.filter(l => l.status === 'fechado').length;
      const valorTotal = leads.filter(l => l.status === 'fechado').reduce((sum, l) => sum + (l.value || 0), 0);

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-negociacao').textContent = negociacao;
      document.getElementById('stat-fechados').textContent = fechados;
      document.getElementById('stat-valor').textContent = `R$ ${valorTotal.toLocaleString('pt-BR')}`;
      document.getElementById('sidebar-total-leads').textContent = total;

      // Pipeline
      const statusCounts = {
        novo: leads.filter(l => l.status === 'novo').length,
        contato: leads.filter(l => l.status === 'contato').length,
        negociacao: negociacao,
        fechado: fechados,
        perdido: leads.filter(l => l.status === 'perdido').length
      };

      const maxCount = Math.max(...Object.values(statusCounts), 1);

      Object.entries(statusCounts).forEach(([status, count]) => {
        const percent = (count / maxCount) * 100;
        document.getElementById(`pipe-${status}`).style.width = `${percent}%`;
        document.getElementById(`pipe-${status}-count`).textContent = count;
      });

      // Recent leads
      const recentLeads = [...leads].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
      const recentContainer = document.getElementById('recent-leads');
      
      if (recentLeads.length === 0) {
        recentContainer.innerHTML = '<p class="text-slate-400 text-sm">Nenhum lead cadastrado</p>';
      } else {
        recentContainer.innerHTML = recentLeads.map(lead => `
          <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/30 transition-colors">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-medium text-sm">
              ${lead.name.charAt(0).toUpperCase()}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium truncate">${lead.name}</p>
              <p class="text-xs text-slate-400">${lead.company || 'Sem empresa'}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full status-${lead.status}">${getStatusLabel(lead.status)}</span>
          </div>
        `).join('');
      }

      // Upcoming events
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const upcomingEvents = events
        .filter(e => new Date(e.event_date) >= today)
        .sort((a, b) => new Date(a.event_date + 'T' + a.event_time) - new Date(b.event_date + 'T' + b.event_time))
        .slice(0, 3);

      const upcomingContainer = document.getElementById('upcoming-events');
      
      if (upcomingEvents.length === 0) {
        upcomingContainer.innerHTML = '<p class="text-slate-400 text-sm col-span-3">Nenhum compromisso agendado</p>';
      } else {
        upcomingContainer.innerHTML = upcomingEvents.map(event => {
          const eventDate = new Date(event.event_date + 'T00:00:00');
          const relatedLead = event.lead_id ? leads.find(l => l.__backendId === event.lead_id) : null;
          return `
            <div class="bg-slate-700/30 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-sm text-slate-400">${eventDate.toLocaleDateString('pt-BR')} às ${event.event_time}</span>
              </div>
              <p class="font-medium">${event.event_title}</p>
              ${relatedLead ? `<p class="text-sm text-slate-400 mt-1">Lead: ${relatedLead.name}</p>` : ''}
            </div>
          `;
        }).join('');
      }
    }

    // Leads
    function updateLeadsTable() {
      filterLeads();
    }

    function filterLeads() {
      const search = document.getElementById('search-leads').value.toLowerCase();
      const statusFilter = document.getElementById('filter-status').value;
      const sourceFilter = document.getElementById('filter-source').value;

      const filtered = leads.filter(lead => {
        const matchSearch = !search || 
          lead.name.toLowerCase().includes(search) ||
          (lead.email && lead.email.toLowerCase().includes(search)) ||
          (lead.company && lead.company.toLowerCase().includes(search));
        const matchStatus = !statusFilter || lead.status === statusFilter;
        const matchSource = !sourceFilter || lead.source === sourceFilter;
        return matchSearch && matchStatus && matchSource;
      });

      renderLeadsTable(filtered);
    }

    function renderLeadsTable(filteredLeads) {
      const tbody = document.getElementById('leads-table-body');
      
      if (filteredLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">Nenhum lead encontrado.</td></tr>';
        return;
      }

      tbody.innerHTML = filteredLeads.map(lead => `
        <tr class="hover:bg-slate-700/30 transition-colors">
          <td class="px-4 py-3">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-medium text-sm">
                ${lead.name.charAt(0).toUpperCase()}
              </div>
              <span class="font-medium">${lead.name}</span>
            </div>
          </td>
          <td class="px-4 py-3 text-slate-300">${lead.company || '-'}</td>
          <td class="px-4 py-3">
            <div class="text-sm">
              <p class="text-slate-300">${lead.email || '-'}</p>
              <p class="text-slate-500">${lead.phone || ''}</p>
            </div>
          </td>
          <td class="px-4 py-3">
            <span class="text-xs px-2 py-1 rounded-full status-${lead.status}">${getStatusLabel(lead.status)}</span>
          </td>
          <td class="px-4 py-3 text-slate-300">${lead.value ? `R$ ${lead.value.toLocaleString('pt-BR')}` : '-'}</td>
          <td class="px-4 py-3 text-slate-300">${getSourceLabel(lead.source)}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <button onclick="editLead('${lead.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-blue-400" title="Editar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteLead('${lead.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-red-400" title="Excluir">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openLeadModal(leadId = null) {
      const modal = document.getElementById('lead-modal');
      const form = document.getElementById('lead-form');
      const title = document.getElementById('lead-modal-title');
      
      form.reset();
      document.getElementById('lead-id').value = '';
      
      if (leadId) {
        const lead = leads.find(l => l.__backendId === leadId);
        if (lead) {
          title.textContent = 'Editar Lead';
          document.getElementById('lead-id').value = lead.__backendId;
          document.getElementById('lead-name').value = lead.name;
          document.getElementById('lead-email').value = lead.email || '';
          document.getElementById('lead-phone').value = lead.phone || '';
          document.getElementById('lead-company').value = lead.company || '';
          document.getElementById('lead-status').value = lead.status;
          document.getElementById('lead-value').value = lead.value || '';
          document.getElementById('lead-source').value = lead.source || 'website';
          document.getElementById('lead-notes').value = lead.notes || '';
        }
      } else {
        title.textContent = 'Novo Lead';
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeLeadModal() {
      const modal = document.getElementById('lead-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function handleLeadSubmit(e) {
      e.preventDefault();
      
      const leadId = document.getElementById('lead-id').value;
      const btn = document.getElementById('lead-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      const leadData = {
        type: 'lead',
        name: document.getElementById('lead-name').value,
        email: document.getElementById('lead-email').value,
        phone: document.getElementById('lead-phone').value,
        company: document.getElementById('lead-company').value,
        status: document.getElementById('lead-status').value,
        value: parseFloat(document.getElementById('lead-value').value) || 0,
        source: document.getElementById('lead-source').value,
        notes: document.getElementById('lead-notes').value,
        updated_at: new Date().toISOString()
      };

      let result;
      if (leadId) {
        const existingLead = leads.find(l => l.__backendId === leadId);
        result = await window.dataSdk.update({
          ...existingLead,
          ...leadData
        });
      } else {
        if (allData.length >= 999) {
          showToast('Limite de 999 registros atingido', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar Lead';
          return;
        }
        leadData.created_at = new Date().toISOString();
        result = await window.dataSdk.create(leadData);
      }

      btn.disabled = false;
      btn.textContent = 'Salvar Lead';

      if (result.isOk) {
        showToast(leadId ? 'Lead atualizado!' : 'Lead criado!', 'success');
        closeLeadModal();
      } else {
        showToast('Erro ao salvar lead', 'error');
      }
    }

    function editLead(leadId) {
      openLeadModal(leadId);
    }

    function deleteLead(leadId) {
      const lead = leads.find(l => l.__backendId === leadId);
      if (lead) {
        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o lead "${lead.name}"?`;
        deleteCallback = async () => {
          const btn = document.getElementById('confirm-delete-btn');
          btn.disabled = true;
          btn.textContent = 'Excluindo...';
          
          const result = await window.dataSdk.delete(lead);
          
          btn.disabled = false;
          btn.textContent = 'Excluir';
          
          if (result.isOk) {
            showToast('Lead excluído!', 'success');
            closeDeleteModal();
          } else {
            showToast('Erro ao excluir lead', 'error');
          }
        };
        openDeleteModal();
      }
    }

    // Events / Agenda
    function updateCalendar() {
      const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      document.getElementById('calendar-month').textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;

      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let daysHtml = '';
      
      for (let i = 0; i < startDay; i++) {
        daysHtml += '<span class="py-2 text-slate-600"></span>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
        const dateStr = date.toISOString().split('T')[0];
        const hasEvents = events.some(e => e.event_date === dateStr);
        const isToday = date.getTime() === today.getTime();
        const isSelected = date.toDateString() === selectedDate.toDateString();
        
        let classes = 'py-2 rounded-lg cursor-pointer transition-colors hover:bg-slate-700/50';
        if (isToday) classes += ' ring-2 ring-blue-500';
        if (isSelected) classes += ' bg-blue-600';
        if (hasEvents && !isSelected) classes += ' bg-purple-500/30';
        
        daysHtml += `<span class="${classes}" onclick="selectDate('${dateStr}')">${day}</span>`;
      }

      document.getElementById('calendar-days').innerHTML = daysHtml;
      updateEventsList();
    }

    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      updateCalendar();
    }

    function selectDate(dateStr) {
      selectedDate = new Date(dateStr + 'T00:00:00');
      updateCalendar();
    }

    function updateEventsList() {
      const dateStr = selectedDate.toISOString().split('T')[0];
      document.getElementById('selected-date').textContent = selectedDate.toLocaleDateString('pt-BR');
      
      const dayEvents = events.filter(e => e.event_date === dateStr).sort((a, b) => a.event_time.localeCompare(b.event_time));
      const container = document.getElementById('events-list');

      if (dayEvents.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-sm">Nenhum evento para esta data</p>';
        return;
      }

      container.innerHTML = dayEvents.map(event => {
        const relatedLead = event.lead_id ? leads.find(l => l.__backendId === event.lead_id) : null;
        return `
          <div class="bg-slate-700/30 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-blue-400 font-medium">${event.event_time}</span>
              <div class="flex items-center gap-2">
                <button onclick="editEvent('${event.__backendId}')" class="p-1 hover:bg-slate-600/50 rounded transition-colors text-slate-400 hover:text-white">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteEvent('${event.__backendId}')" class="p-1 hover:bg-slate-600/50 rounded transition-colors text-slate-400 hover:text-red-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
            <p class="font-medium">${event.event_title}</p>
            ${relatedLead ? `<p class="text-sm text-slate-400 mt-1">Lead: ${relatedLead.name}</p>` : ''}
            ${event.notes ? `<p class="text-sm text-slate-500 mt-2">${event.notes}</p>` : ''}
          </div>
        `;
      }).join('');
    }

    function updateEventLeadSelect() {
      const select = document.getElementById('event-lead');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Nenhum</option>' + 
        leads.map(lead => `<option value="${lead.__backendId}">${lead.name}</option>`).join('');
      if (currentValue && leads.some(l => l.__backendId === currentValue)) {
        select.value = currentValue;
      }
    }

    function openEventModal(eventId = null) {
      const modal = document.getElementById('event-modal');
      const form = document.getElementById('event-form');
      const title = document.getElementById('event-modal-title');
      
      form.reset();
      document.getElementById('event-id').value = '';
      updateEventLeadSelect();
      
      if (eventId) {
        const event = events.find(e => e.__backendId === eventId);
        if (event) {
          title.textContent = 'Editar Evento';
          document.getElementById('event-id').value = event.__backendId;
          document.getElementById('event-title').value = event.event_title;
          document.getElementById('event-date').value = event.event_date;
          document.getElementById('event-time').value = event.event_time;
          document.getElementById('event-lead').value = event.lead_id || '';
          document.getElementById('event-notes').value = event.notes || '';
        }
      } else {
        title.textContent = 'Novo Evento';
        document.getElementById('event-date').value = selectedDate.toISOString().split('T')[0];
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeEventModal() {
      const modal = document.getElementById('event-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function handleEventSubmit(e) {
      e.preventDefault();
      
      const eventId = document.getElementById('event-id').value;
      const btn = document.getElementById('event-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      const eventData = {
        type: 'event',
        event_title: document.getElementById('event-title').value,
        event_date: document.getElementById('event-date').value,
        event_time: document.getElementById('event-time').value,
        lead_id: document.getElementById('event-lead').value || null,
        notes: document.getElementById('event-notes').value,
        updated_at: new Date().toISOString()
      };

      let result;
      if (eventId) {
        const existingEvent = events.find(e => e.__backendId === eventId);
        result = await window.dataSdk.update({
          ...existingEvent,
          ...eventData
        });
      } else {
        if (allData.length >= 999) {
          showToast('Limite de 999 registros atingido', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar Evento';
          return;
        }
        eventData.created_at = new Date().toISOString();
        result = await window.dataSdk.create(eventData);
      }

      btn.disabled = false;
      btn.textContent = 'Salvar Evento';

      if (result.isOk) {
        showToast(eventId ? 'Evento atualizado!' : 'Evento criado!', 'success');
        closeEventModal();
      } else {
        showToast('Erro ao salvar evento', 'error');
      }
    }

    function editEvent(eventId) {
      openEventModal(eventId);
    }

    function deleteEvent(eventId) {
      const event = events.find(e => e.__backendId === eventId);
      if (event) {
        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o evento "${event.event_title}"?`;
        deleteCallback = async () => {
          const btn = document.getElementById('confirm-delete-btn');
          btn.disabled = true;
          btn.textContent = 'Excluindo...';
          
          const result = await window.dataSdk.delete(event);
          
          btn.disabled = false;
          btn.textContent = 'Excluir';
          
          if (result.isOk) {
            showToast('Evento excluído!', 'success');
            closeDeleteModal();
          } else {
            showToast('Erro ao excluir evento', 'error');
          }
        };
        openDeleteModal();
      }
    }

    // Historico
    function updateHistoricoLeadFilter() {
      const select = document.getElementById('historico-lead-filter');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Todos os Leads</option>' + 
        leads.map(lead => `<option value="${lead.__backendId}">${lead.name}</option>`).join('');
      if (currentValue && leads.some(l => l.__backendId === currentValue)) {
        select.value = currentValue;
      }
    }

    function filterHistorico() {
      renderHistorico();
    }

    function renderHistorico() {
      const leadFilter = document.getElementById('historico-lead-filter').value;
      const dateStart = document.getElementById('historico-date-start').value;
      const dateEnd = document.getElementById('historico-date-end').value;

      let filteredLeads = leads;
      let filteredEvents = events;

      if (leadFilter) {
        filteredLeads = leads.filter(l => l.__backendId === leadFilter);
        filteredEvents = events.filter(e => e.lead_id === leadFilter);
      }

      // Combine and sort by date
      const timeline = [
        ...filteredLeads.map(l => ({ ...l, itemType: 'lead', date: l.created_at })),
        ...filteredEvents.map(e => ({ ...e, itemType: 'event', date: e.event_date + 'T' + e.event_time }))
      ].sort((a, b) => new Date(b.date) - new Date(a.date));

      // Filter by date range
      const filtered = timeline.filter(item => {
        const itemDate = new Date(item.date).toISOString().split('T')[0];
        if (dateStart && itemDate < dateStart) return false;
        if (dateEnd && itemDate > dateEnd) return false;
        return true;
      });

      const container = document.getElementById('historico-timeline');

      if (filtered.length === 0) {
        container.innerHTML = '<div class="card-glass rounded-xl p-6 text-center"><p class="text-slate-400">Nenhum histórico encontrado</p></div>';
        return;
      }

      container.innerHTML = filtered.map(item => {
        const date = new Date(item.date);
        if (item.itemType === 'lead') {
          return `
            <div class="card-glass rounded-xl p-5 flex items-start gap-4">
              <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs px-2 py-1 rounded-full status-${item.status}">${getStatusLabel(item.status)}</span>
                  <span class="text-slate-500 text-sm">${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <p class="font-medium">${item.name}</p>
                <p class="text-sm text-slate-400">${item.company || 'Sem empresa'} • ${item.email || 'Sem email'}</p>
                ${item.notes ? `<p class="text-sm text-slate-500 mt-2">${item.notes}</p>` : ''}
              </div>
            </div>
          `;
        } else {
          const relatedLead = item.lead_id ? leads.find(l => l.__backendId === item.lead_id) : null;
          return `
            <div class="card-glass rounded-xl p-5 flex items-start gap-4">
              <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs px-2 py-1 rounded-full bg-purple-500/30 text-purple-300">Evento</span>
                  <span class="text-slate-500 text-sm">${date.toLocaleDateString('pt-BR')} às ${item.event_time}</span>
                </div>
                <p class="font-medium">${item.event_title}</p>
                ${relatedLead ? `<p class="text-sm text-slate-400">Lead: ${relatedLead.name}</p>` : ''}
                ${item.notes ? `<p class="text-sm text-slate-500 mt-2">${item.notes}</p>` : ''}
              </div>
            </div>
          `;
        }
      }).join('');
    }

    // Import/Export
    function updateExportCount() {
      const statusFilter = document.getElementById('export-status').value;
      const count = statusFilter ? leads.filter(l => l.status === statusFilter).length : leads.length;
      document.getElementById('export-count').textContent = `${count} lead(s) serão exportados`;
    }

    document.getElementById('export-status').addEventListener('change', updateExportCount);

    function downloadTemplate() {
      const template = [
        { Nome: '', Email: '', Telefone: '', Empresa: '', Status: 'novo', Valor: 0, Origem: 'website', Observacoes: '' }
      ];
      
      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Leads');
      XLSX.writeFile(wb, 'modelo_leads.xlsx');
      showToast('Modelo baixado!', 'success');
    }

    async function importExcel(event) {
      const file = event.target.files[0];
      if (!file) return;

      const statusEl = document.getElementById('import-status');
      const messageEl = document.getElementById('import-message');
      
      statusEl.classList.remove('hidden');
      messageEl.textContent = 'Processando arquivo...';
      messageEl.className = 'text-sm text-blue-400';

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet);

          if (jsonData.length === 0) {
            messageEl.textContent = 'Arquivo vazio ou formato inválido';
            messageEl.className = 'text-sm text-red-400';
            return;
          }

          if (allData.length + jsonData.length > 999) {
            messageEl.textContent = `Limite de 999 registros. Você pode importar no máximo ${999 - allData.length} leads.`;
            messageEl.className = 'text-sm text-red-400';
            return;
          }

          let imported = 0;
          for (const row of jsonData) {
            const leadData = {
              type: 'lead',
              name: row.Nome || row.name || '',
              email: row.Email || row.email || '',
              phone: row.Telefone || row.phone || '',
              company: row.Empresa || row.company || '',
              status: (row.Status || row.status || 'novo').toLowerCase(),
              value: parseFloat(row.Valor || row.value) || 0,
              source: (row.Origem || row.source || 'outro').toLowerCase(),
              notes: row.Observacoes || row.notes || '',
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            };

            if (leadData.name) {
              const result = await window.dataSdk.create(leadData);
              if (result.isOk) imported++;
            }
          }

          messageEl.textContent = `${imported} lead(s) importado(s) com sucesso!`;
          messageEl.className = 'text-sm text-green-400';
          showToast(`${imported} leads importados!`, 'success');
        } catch (error) {
          messageEl.textContent = 'Erro ao processar arquivo';
          messageEl.className = 'text-sm text-red-400';
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    function exportExcel() {
      const statusFilter = document.getElementById('export-status').value;
      const filteredLeads = statusFilter ? leads.filter(l => l.status === statusFilter) : leads;

      if (filteredLeads.length === 0) {
        showToast('Nenhum lead para exportar', 'error');
        return;
      }

      const exportData = filteredLeads.map(lead => ({
        Nome: lead.name,
        Email: lead.email || '',
        Telefone: lead.phone || '',
        Empresa: lead.company || '',
        Status: getStatusLabel(lead.status),
        Valor: lead.value || 0,
        Origem: getSourceLabel(lead.source),
        Observacoes: lead.notes || '',
        'Data Criação': new Date(lead.created_at).toLocaleDateString('pt-BR')
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Leads');
      XLSX.writeFile(wb, `leads_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('Exportação concluída!', 'success');
    }

    // Reports
    function generateReport(type) {
      currentReportType = type;
      const preview = document.getElementById('report-preview');
      const title = document.getElementById('report-title');
      const content = document.getElementById('report-content');

      let reportHtml = '';
      const date = new Date().toLocaleDateString('pt-BR');

      if (type === 'geral') {
        title.textContent = 'Relatório Geral de Vendas';
        const totalLeads = leads.length;
        const fechados = leads.filter(l => l.status === 'fechado');
        const valorTotal = fechados.reduce((sum, l) => sum + (l.value || 0), 0);
        const taxaConversao = totalLeads > 0 ? ((fechados.length / totalLeads) * 100).toFixed(1) : 0;

        reportHtml = `
          <div class="space-y-6">
            <div class="text-center border-b pb-4">
              <h2 class="text-2xl font-bold text-slate-800">Relatório Geral de Vendas</h2>
              <p class="text-slate-500">Gerado em ${date}</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-slate-100 rounded-lg p-4">
                <p class="text-slate-600 text-sm">Total de Leads</p>
                <p class="text-3xl font-bold text-slate-800">${totalLeads}</p>
              </div>
              <div class="bg-slate-100 rounded-lg p-4">
                <p class="text-slate-600 text-sm">Leads Fechados</p>
                <p class="text-3xl font-bold text-green-600">${fechados.length}</p>
              </div>
              <div class="bg-slate-100 rounded-lg p-4">
                <p class="text-slate-600 text-sm">Valor Total</p>
                <p class="text-3xl font-bold text-blue-600">R$ ${valorTotal.toLocaleString('pt-BR')}</p>
              </div>
              <div class="bg-slate-100 rounded-lg p-4">
                <p class="text-slate-600 text-sm">Taxa de Conversão</p>
                <p class="text-3xl font-bold text-purple-600">${taxaConversao}%</p>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-semibold text-slate-800 mb-3">Distribuição por Status</h3>
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2 text-slate-600">Status</th>
                    <th class="text-right py-2 text-slate-600">Quantidade</th>
                    <th class="text-right py-2 text-slate-600">%</th>
                  </tr>
                </thead>
                <tbody>
                  ${['novo', 'contato', 'negociacao', 'fechado', 'perdido'].map(status => {
                    const count = leads.filter(l => l.status === status).length;
                    const percent = totalLeads > 0 ? ((count / totalLeads) * 100).toFixed(1) : 0;
                    return `
                      <tr class="border-b">
                        <td class="py-2">${getStatusLabel(status)}</td>
                        <td class="text-right">${count}</td>
                        <td class="text-right">${percent}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } else if (type === 'conversao') {
        title.textContent = 'Relatório de Taxa de Conversão';
        const stages = ['novo', 'contato', 'negociacao', 'fechado'];
        const stageCounts = stages.map(s => leads.filter(l => l.status === s || 
          (s === 'fechado' && l.status === 'fechado')).length);

        reportHtml = `
          <div class="space-y-6">
            <div class="text-center border-b pb-4">
              <h2 class="text-2xl font-bold text-slate-800">Relatório de Taxa de Conversão</h2>
              <p class="text-slate-500">Gerado em ${date}</p>
            </div>

            <div>
              <h3 class="text-lg font-semibold text-slate-800 mb-3">Funil de Vendas</h3>
              <div class="space-y-3">
                ${stages.map((stage, i) => {
                  const count = leads.filter(l => l.status === stage).length;
                  const total = leads.length;
                  const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                  return `
                    <div class="flex items-center gap-4">
                      <span class="w-24 text-sm text-slate-600">${getStatusLabel(stage)}</span>
                      <div class="flex-1 h-6 bg-slate-200 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500" style="width: ${percent}%"></div>
                      </div>
                      <span class="w-20 text-right text-sm">${count} (${percent}%)</span>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <div class="bg-slate-100 rounded-lg p-4">
              <p class="text-slate-600 text-sm mb-2">Taxa de Conversão Geral</p>
              <p class="text-4xl font-bold text-green-600">
                ${leads.length > 0 ? ((leads.filter(l => l.status === 'fechado').length / leads.length) * 100).toFixed(1) : 0}%
              </p>
              <p class="text-slate-500 text-sm mt-1">de leads convertidos em vendas</p>
            </div>
          </div>
        `;
      } else if (type === 'origem') {
        title.textContent = 'Relatório de Leads por Origem';
        const sources = ['website', 'indicacao', 'linkedin', 'instagram', 'facebook', 'google', 'outro'];
        const sourceData = sources.map(source => ({
          source,
          count: leads.filter(l => l.source === source).length,
          value: leads.filter(l => l.source === source && l.status === 'fechado').reduce((sum, l) => sum + (l.value || 0), 0)
        })).filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        reportHtml = `
          <div class="space-y-6">
            <div class="text-center border-b pb-4">
              <h2 class="text-2xl font-bold text-slate-800">Relatório de Leads por Origem</h2>
              <p class="text-slate-500">Gerado em ${date}</p>
            </div>

            <div>
              <h3 class="text-lg font-semibold text-slate-800 mb-3">Distribuição por Canal</h3>
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-2 text-slate-600">Origem</th>
                    <th class="text-right py-2 text-slate-600">Leads</th>
                    <th class="text-right py-2 text-slate-600">%</th>
                    <th class="text-right py-2 text-slate-600">Valor Fechado</th>
                  </tr>
                </thead>
                <tbody>
                  ${sourceData.map(s => {
                    const percent = leads.length > 0 ? ((s.count / leads.length) * 100).toFixed(1) : 0;
                    return `
                      <tr class="border-b">
                        <td class="py-2">${getSourceLabel(s.source)}</td>
                        <td class="text-right">${s.count}</td>
                        <td class="text-right">${percent}%</td>
                        <td class="text-right">R$ ${s.value.toLocaleString('pt-BR')}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>

            ${sourceData.length > 0 ? `
              <div class="bg-slate-100 rounded-lg p-4">
                <p class="text-slate-600 text-sm mb-2">Principal Canal de Aquisição</p>
                <p class="text-2xl font-bold text-blue-600">${getSourceLabel(sourceData[0].source)}</p>
                <p class="text-slate-500 text-sm mt-1">${sourceData[0].count} leads (${((sourceData[0].count / leads.length) * 100).toFixed(1)}% do total)</p>
              </div>
            ` : ''}
          </div>
        `;
      }

      content.innerHTML = reportHtml;
      currentReportData = reportHtml;
      preview.classList.remove('hidden');
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const titles = {
        geral: 'Relatório Geral de Vendas',
        conversao: 'Relatório de Taxa de Conversão',
        origem: 'Relatório de Leads por Origem'
      };

      doc.setFontSize(20);
      doc.text(titles[currentReportType], 20, 20);
      
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
      
      doc.setTextColor(0);
      doc.setFontSize(12);
      
      let y = 45;

      if (currentReportType === 'geral') {
        const totalLeads = leads.length;
        const fechados = leads.filter(l => l.status === 'fechado');
        const valorTotal = fechados.reduce((sum, l) => sum + (l.value || 0), 0);
        const taxaConversao = totalLeads > 0 ? ((fechados.length / totalLeads) * 100).toFixed(1) : 0;

        doc.text(`Total de Leads: ${totalLeads}`, 20, y); y += 10;
        doc.text(`Leads Fechados: ${fechados.length}`, 20, y); y += 10;
        doc.text(`Valor Total: R$ ${valorTotal.toLocaleString('pt-BR')}`, 20, y); y += 10;
        doc.text(`Taxa de Conversão: ${taxaConversao}%`, 20, y); y += 20;

        doc.setFontSize(14);
        doc.text('Distribuição por Status', 20, y); y += 10;
        doc.setFontSize(12);

        ['novo', 'contato', 'negociacao', 'fechado', 'perdido'].forEach(status => {
          const count = leads.filter(l => l.status === status).length;
          const percent = totalLeads > 0 ? ((count / totalLeads) * 100).toFixed(1) : 0;
          doc.text(`${getStatusLabel(status)}: ${count} (${percent}%)`, 20, y);
          y += 8;
        });
      } else if (currentReportType === 'conversao') {
        const taxaGeral = leads.length > 0 ? 
          ((leads.filter(l => l.status === 'fechado').length / leads.length) * 100).toFixed(1) : 0;

        doc.setFontSize(14);
        doc.text('Funil de Vendas', 20, y); y += 10;
        doc.setFontSize(12);

        ['novo', 'contato', 'negociacao', 'fechado'].forEach(stage => {
          const count = leads.filter(l => l.status === stage).length;
          const percent = leads.length > 0 ? ((count / leads.length) * 100).toFixed(1) : 0;
          doc.text(`${getStatusLabel(stage)}: ${count} (${percent}%)`, 20, y);
          y += 8;
        });

        y += 10;
        doc.setFontSize(14);
        doc.text(`Taxa de Conversão Geral: ${taxaGeral}%`, 20, y);
      } else if (currentReportType === 'origem') {
        const sources = ['website', 'indicacao', 'linkedin', 'instagram', 'facebook', 'google', 'outro'];
        const sourceData = sources.map(source => ({
          source,
          count: leads.filter(l => l.source === source).length,
          value: leads.filter(l => l.source === source && l.status === 'fechado').reduce((sum, l) => sum + (l.value || 0), 0)
        })).filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        doc.setFontSize(14);
        doc.text('Distribuição por Canal', 20, y); y += 10;
        doc.setFontSize(12);

        sourceData.forEach(s => {
          const percent = leads.length > 0 ? ((s.count / leads.length) * 100).toFixed(1) : 0;
          doc.text(`${getSourceLabel(s.source)}: ${s.count} leads (${percent}%) - R$ ${s.value.toLocaleString('pt-BR')}`, 20, y);
          y += 8;
        });
      }

      doc.save(`relatorio_${currentReportType}_${new Date().toISOString().split('T')[0]}.pdf`);
      showToast('PDF gerado com sucesso!', 'success');
    }

    // Delete Modal
    function openDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      deleteCallback = null;
    }

    function confirmDelete() {
      if (deleteCallback) {
        deleteCallback();
      }
    }

    // Toast
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `px-4 py-3 rounded-lg shadow-lg animate-fade-in flex items-center gap-3 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      }`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
          }
        </svg>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Helpers
    function getStatusLabel(status) {
      const labels = {
        novo: 'Novo',
        contato: 'Contato',
        negociacao: 'Negociação',
        fechado: 'Fechado',
        perdido: 'Perdido'
      };
      return labels[status] || status;
    }

    function getSourceLabel(source) {
      const labels = {
        website: 'Website',
        indicacao: 'Indicação',
        linkedin: 'LinkedIn',
        instagram: 'Instagram',
        facebook: 'Facebook',
        google: 'Google Ads',
        outro: 'Outro'
      };
      return labels[source] || source;
    }

    // Initialize app
    init();

    // Goals Management
    let goals = [];

    function getGoalsData() {
      return allData.filter(d => d.type === 'goal');
    }

    function updateGoalsDisplay() {
      goals = getGoalsData();
      renderGoalsTable();
      calculateGoalProgress();
      renderWeeklyDailyGoals();
    }

    function calculateGoalProgress() {
      const today = new Date();
      const currentWeek = getWeekStart(today);
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const currentDay = today.toISOString().split('T')[0];

      // Calculate current values
      let currentRevenue = 0;
      let currentMeetings = 0;
      let currentSales = 0;

      let weeklyMeetings = 0;
      let weeklySales = 0;
      let dailyMeetings = 0;
      let dailySales = 0;

      // Revenue: closed deals this month
      leads.forEach(lead => {
        if (lead.status === 'fechado') {
          const leadDate = new Date(lead.updated_at);
          if (leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear) {
            currentRevenue += lead.value || 0;
          }
        }
      });

      // Meetings and Sales
      events.forEach(event => {
        const eventDate = new Date(event.event_date);
        const eventWeekStart = getWeekStart(eventDate);
        const leadConnected = event.lead_id ? leads.find(l => l.__backendId === event.lead_id) : null;

        // Count meetings this month
        if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {
          currentMeetings++;
        }

        // Weekly meetings
        if (eventWeekStart.getTime() === currentWeek.getTime()) {
          weeklyMeetings++;
        }

        // Daily meetings
        if (event.event_date === currentDay) {
          dailyMeetings++;
        }
      });

      // Count closed leads (sales) this month
      leads.forEach(lead => {
        if (lead.status === 'fechado') {
          const leadDate = new Date(lead.updated_at);
          if (leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear) {
            currentSales++;
          }
        }
      });

      // Weekly sales
      leads.forEach(lead => {
        if (lead.status === 'fechado') {
          const leadDate = new Date(lead.updated_at);
          const leadWeek = getWeekStart(leadDate);
          if (leadWeek.getTime() === currentWeek.getTime()) {
            weeklySales++;
          }
        }
      });

      // Daily sales
      leads.forEach(lead => {
        if (lead.status === 'fechado') {
          const leadDate = lead.updated_at.split('T')[0];
          if (leadDate === currentDay) {
            dailySales++;
          }
        }
      });

      // Update goal cards
      goals.forEach(goal => {
        let current = 0;
        let target = goal.goal_target || 0;

        if (goal.goal_type === 'faturamento') {
          current = currentRevenue;
        } else if (goal.goal_type === 'atendimentos') {
          if (goal.goal_period === 'mensal') current = currentMeetings;
          else if (goal.goal_period === 'semanal') current = weeklyMeetings;
          else if (goal.goal_period === 'diaria') current = dailyMeetings;
        } else if (goal.goal_type === 'vendas') {
          if (goal.goal_period === 'mensal') current = currentSales;
          else if (goal.goal_period === 'semanal') current = weeklySales;
          else if (goal.goal_period === 'diaria') current = dailySales;
        }

        const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;

        // Update main cards
        if (goal.goal_type === 'faturamento' && goal.goal_period === 'mensal') {
          document.getElementById('goal-revenue-current').textContent = `R$ ${current.toLocaleString('pt-BR')}`;
          document.getElementById('goal-revenue-target').textContent = `R$ ${target.toLocaleString('pt-BR')}`;
          document.getElementById('goal-revenue-progress').style.width = `${percent}%`;
          document.getElementById('goal-revenue-percent').textContent = `${percent.toFixed(0)}% da meta`;
        } else if (goal.goal_type === 'atendimentos' && goal.goal_period === 'semanal') {
          document.getElementById('goal-meetings-current').textContent = current;
          document.getElementById('goal-meetings-target').textContent = target;
          document.getElementById('goal-meetings-progress').style.width = `${percent}%`;
          document.getElementById('goal-meetings-percent').textContent = `${percent.toFixed(0)}% da meta`;
        } else if (goal.goal_type === 'vendas' && goal.goal_period === 'mensal') {
          document.getElementById('goal-sales-current').textContent = current;
          document.getElementById('goal-sales-target').textContent = target;
          document.getElementById('goal-sales-progress').style.width = `${percent}%`;
          document.getElementById('goal-sales-percent').textContent = `${percent.toFixed(0)}% da meta`;
        }
      });
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function renderGoalsTable() {
      const tbody = document.getElementById('goals-table-body');

      if (goals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">Nenhuma meta cadastrada.</td></tr>';
        return;
      }

      const today = new Date();
      const currentWeek = getWeekStart(today);
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const currentDay = today.toISOString().split('T')[0];

      tbody.innerHTML = goals.map(goal => {
        let current = 0;
        const target = goal.goal_target || 0;
        const typeLabel = { faturamento: 'Faturamento', atendimentos: 'Atendimentos', vendas: 'Vendas' }[goal.goal_type] || goal.goal_type;
        const periodLabel = { diaria: 'Diária', semanal: 'Semanal', mensal: 'Mensal' }[goal.goal_period] || goal.goal_period;

        // Calculate current
        if (goal.goal_type === 'faturamento') {
          leads.forEach(lead => {
            if (lead.status === 'fechado') {
              const leadDate = new Date(lead.updated_at);
              if (leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear) {
                current += lead.value || 0;
              }
            }
          });
        } else if (goal.goal_type === 'atendimentos') {
          events.forEach(event => {
            const eventDate = new Date(event.event_date);
            const eventWeek = getWeekStart(eventDate);
            if (goal.goal_period === 'mensal' && eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {
              current++;
            } else if (goal.goal_period === 'semanal' && eventWeek.getTime() === currentWeek.getTime()) {
              current++;
            } else if (goal.goal_period === 'diaria' && event.event_date === currentDay) {
              current++;
            }
          });
        } else if (goal.goal_type === 'vendas') {
          leads.forEach(lead => {
            if (lead.status === 'fechado') {
              const leadDate = new Date(lead.updated_at);
              const leadWeek = getWeekStart(leadDate);
              if (goal.goal_period === 'mensal' && leadDate.getMonth() === currentMonth && leadDate.getFullYear() === currentYear) {
                current++;
              } else if (goal.goal_period === 'semanal' && leadWeek.getTime() === currentWeek.getTime()) {
                current++;
              } else if (goal.goal_period === 'diaria' && lead.updated_at.split('T')[0] === currentDay) {
                current++;
              }
            }
          });
        }

        const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;
        const currentDisplay = goal.goal_type === 'faturamento' ? `R$ ${current.toLocaleString('pt-BR')}` : current;
        const targetDisplay = goal.goal_type === 'faturamento' ? `R$ ${target.toLocaleString('pt-BR')}` : target;

        return `
          <tr class="hover:bg-slate-700/30 transition-colors">
            <td class="px-4 py-3 font-medium">${typeLabel}</td>
            <td class="px-4 py-3 text-slate-300">${periodLabel}</td>
            <td class="px-4 py-3 text-slate-300">${targetDisplay}</td>
            <td class="px-4 py-3 text-slate-300">${currentDisplay}</td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <div class="flex-1 h-2 bg-slate-700/50 rounded-full overflow-hidden" style="min-width: 100px;">
                  <div class="h-full ${percent >= 100 ? 'bg-green-500' : percent >= 75 ? 'bg-blue-500' : percent >= 50 ? 'bg-amber-500' : 'bg-red-500'} transition-all duration-500" style="width: ${percent}%"></div>
                </div>
                <span class="text-sm text-slate-300 min-w-[45px] text-right">${percent.toFixed(0)}%</span>
              </div>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <button onclick="editGoal('${goal.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-blue-400" title="Editar">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteGoal('${goal.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-red-400" title="Excluir">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderWeeklyDailyGoals() {
      const today = new Date();
      const currentWeek = getWeekStart(today);
      const currentDay = today.toISOString().split('T')[0];

      const weeklyContainer = document.getElementById('weekly-goals');
      const dailyContainer = document.getElementById('daily-goals');

      const weeklyGoals = goals.filter(g => g.goal_period === 'semanal');
      const dailyGoals = goals.filter(g => g.goal_period === 'diaria');

      // Weekly
      if (weeklyGoals.length === 0) {
        weeklyContainer.innerHTML = '<p class="text-slate-400 text-sm">Nenhuma meta semanal</p>';
      } else {
        weeklyContainer.innerHTML = weeklyGoals.map(goal => {
          let current = 0;
          const target = goal.goal_target || 0;

          if (goal.goal_type === 'atendimentos') {
            events.forEach(event => {
              const eventDate = new Date(event.event_date);
              const eventWeek = getWeekStart(eventDate);
              if (eventWeek.getTime() === currentWeek.getTime()) current++;
            });
          } else if (goal.goal_type === 'vendas') {
            leads.forEach(lead => {
              if (lead.status === 'fechado') {
                const leadDate = new Date(lead.updated_at);
                const leadWeek = getWeekStart(leadDate);
                if (leadWeek.getTime() === currentWeek.getTime()) current++;
              }
            });
          }

          const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;
          const typeLabel = goal.goal_type === 'atendimentos' ? 'Atendimentos' : 'Vendas';

          return `
            <div class="bg-slate-700/30 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium">${typeLabel}</span>
                <span class="text-sm text-slate-400">${current} / ${target}</span>
              </div>
              <div class="h-2 bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 transition-all duration-500" style="width: ${percent}%"></div>
              </div>
              <p class="text-xs text-slate-500 mt-2">${percent.toFixed(0)}% concluído</p>
            </div>
          `;
        }).join('');
      }

      // Daily
      if (dailyGoals.length === 0) {
        dailyContainer.innerHTML = '<p class="text-slate-400 text-sm">Nenhuma meta diária</p>';
      } else {
        dailyContainer.innerHTML = dailyGoals.map(goal => {
          let current = 0;
          const target = goal.goal_target || 0;

          if (goal.goal_type === 'atendimentos') {
            events.forEach(event => {
              if (event.event_date === currentDay) current++;
            });
          } else if (goal.goal_type === 'vendas') {
            leads.forEach(lead => {
              if (lead.status === 'fechado' && lead.updated_at.split('T')[0] === currentDay) {
                current++;
              }
            });
          }

          const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;
          const typeLabel = goal.goal_type === 'atendimentos' ? 'Atendimentos' : 'Vendas';

          return `
            <div class="bg-slate-700/30 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium">${typeLabel}</span>
                <span class="text-sm text-slate-400">${current} / ${target}</span>
              </div>
              <div class="h-2 bg-slate-600 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 transition-all duration-500" style="width: ${percent}%"></div>
              </div>
              <p class="text-xs text-slate-500 mt-2">${percent.toFixed(0)}% concluído</p>
            </div>
          `;
        }).join('');
      }
    }

    function openGoalModal(goalId = null) {
      const modal = document.getElementById('goal-modal');
      const form = document.getElementById('goal-form');
      const title = document.getElementById('goal-modal-title');

      form.reset();
      document.getElementById('goal-id').value = '';

      if (goalId) {
        const goal = goals.find(g => g.__backendId === goalId);
        if (goal) {
          title.textContent = 'Editar Meta';
          document.getElementById('goal-id').value = goal.__backendId;
          document.getElementById('goal-type').value = goal.goal_type;
          document.getElementById('goal-period').value = goal.goal_period;
          document.getElementById('goal-target').value = goal.goal_target;
        }
      } else {
        title.textContent = 'Nova Meta';
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeGoalModal() {
      const modal = document.getElementById('goal-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('goal-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const goalId = document.getElementById('goal-id').value;
      const btn = document.getElementById('goal-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      const goalData = {
        type: 'goal',
        goal_type: document.getElementById('goal-type').value,
        goal_period: document.getElementById('goal-period').value,
        goal_target: parseFloat(document.getElementById('goal-target').value),
        updated_at: new Date().toISOString()
      };

      let result;
      if (goalId) {
        const existingGoal = goals.find(g => g.__backendId === goalId);
        result = await window.dataSdk.update({
          ...existingGoal,
          ...goalData
        });
      } else {
        if (allData.length >= 999) {
          showToast('Limite de 999 registros atingido', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar Meta';
          return;
        }
        goalData.created_at = new Date().toISOString();
        result = await window.dataSdk.create(goalData);
      }

      btn.disabled = false;
      btn.textContent = 'Salvar Meta';

      if (result.isOk) {
        showToast(goalId ? 'Meta atualizada!' : 'Meta criada!', 'success');
        closeGoalModal();
      } else {
        showToast('Erro ao salvar meta', 'error');
      }
    });

    function editGoal(goalId) {
      openGoalModal(goalId);
    }

    function deleteGoal(goalId) {
      const goal = goals.find(g => g.__backendId === goalId);
      if (goal) {
        const typeLabel = { faturamento: 'Faturamento', atendimentos: 'Atendimentos', vendas: 'Vendas' }[goal.goal_type];
        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir a meta de ${typeLabel}?`;
        deleteCallback = async () => {
          const btn = document.getElementById('confirm-delete-btn');
          btn.disabled = true;
          btn.textContent = 'Excluindo...';

          const result = await window.dataSdk.delete(goal);

          btn.disabled = false;
          btn.textContent = 'Excluir';

          if (result.isOk) {
            showToast('Meta excluída!', 'success');
            closeDeleteModal();
          } else {
            showToast('Erro ao excluir meta', 'error');
          }
        };
        openDeleteModal();
      }
    }

    // Update data handler to include goals
    const originalHandler = dataHandler;
    dataHandler.onDataChanged = function(data) {
      allData = data;
      leads = data.filter(d => d.type === 'lead');
      events = data.filter(d => d.type === 'event');
      goals = data.filter(d => d.type === 'goal');
      reminders = data.filter(d => d.type === 'reminder');
      
      updateDashboard();
      updateLeadsTable();
      updateCalendar();
      updateHistoricoLeadFilter();
      updateEventLeadSelect();
      updateExportCount();
      updateGoalsDisplay();
      updateRemindersDisplay();
      checkReminders();
    };

    // Reminders Management
    function updateRemindersDisplay() {
      updateRemindersBadge();
      updateRemindersLeadFilter();
      renderRemindersTable();
      renderActiveReminders();
    }

    function updateRemindersBadge() {
      const pending = reminders.filter(r => !r.reminder_completed).length;
      const badge = document.getElementById('reminder-badge');
      if (pending > 0) {
        badge.textContent = pending;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function updateRemindersLeadFilter() {
      const select = document.getElementById('reminder-filter-lead');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Todos</option>' + 
        leads.map(lead => `<option value="${lead.__backendId}">${lead.name}</option>`).join('');
      if (currentValue && leads.some(l => l.__backendId === currentValue)) {
        select.value = currentValue;
      }
    }

    function renderActiveReminders() {
      const container = document.getElementById('active-reminders');
      const pending = reminders.filter(r => !r.reminder_completed);

      if (pending.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-sm">Nenhum lembrete pendente</p>';
        return;
      }

      const sorted = pending.sort((a, b) => {
        const dateA = new Date(a.reminder_date + 'T' + a.reminder_time);
        const dateB = new Date(b.reminder_date + 'T' + b.reminder_time);
        return dateA - dateB;
      });

      container.innerHTML = sorted.slice(0, 5).map(reminder => {
        const relatedLead = reminder.reminder_lead_id ? leads.find(l => l.__backendId === reminder.reminder_lead_id) : null;
        const reminderDate = new Date(reminder.reminder_date + 'T' + reminder.reminder_time);
        const now = new Date();
        const isOverdue = reminderDate < now;

        return `
          <div class="bg-slate-700/50 rounded-lg p-4 border-l-4 ${isOverdue ? 'border-red-500' : 'border-blue-500'}">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <p class="font-medium ${isOverdue ? 'text-red-300' : 'text-white'}">${reminder.reminder_title}</p>
                <p class="text-sm text-slate-400 mt-1">${reminderDate.toLocaleString('pt-BR')}</p>
              </div>
              <button onclick="completeReminder('${reminder.__backendId}')" class="p-2 hover:bg-slate-600/50 rounded transition-colors text-green-400" title="Concluir">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </button>
            </div>
            ${reminder.reminder_description ? `<p class="text-sm text-slate-300 mb-2">${reminder.reminder_description}</p>` : ''}
            ${relatedLead ? `<p class="text-xs text-slate-500">Lead: ${relatedLead.name}</p>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderRemindersTable() {
      const statusFilter = document.getElementById('reminder-filter-status').value;
      const leadFilter = document.getElementById('reminder-filter-lead').value;
      const tbody = document.getElementById('reminders-table-body');

      let filtered = reminders;
      if (statusFilter === 'pendente') {
        filtered = reminders.filter(r => !r.reminder_completed);
      } else if (statusFilter === 'concluido') {
        filtered = reminders.filter(r => r.reminder_completed);
      }

      if (leadFilter) {
        filtered = filtered.filter(r => r.reminder_lead_id === leadFilter);
      }

      filtered = filtered.sort((a, b) => new Date(b.reminder_date + 'T' + b.reminder_time) - new Date(a.reminder_date + 'T' + a.reminder_time));

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Nenhum lembrete encontrado</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(reminder => {
        const relatedLead = reminder.reminder_lead_id ? leads.find(l => l.__backendId === reminder.reminder_lead_id) : null;
        const reminderDate = new Date(reminder.reminder_date + 'T' + reminder.reminder_time);
        const statusClass = reminder.reminder_completed ? 'text-green-400' : 'text-yellow-400';
        const statusText = reminder.reminder_completed ? 'Concluído' : 'Pendente';

        return `
          <tr class="hover:bg-slate-700/30 transition-colors">
            <td class="px-4 py-3">${reminder.reminder_title}</td>
            <td class="px-4 py-3 text-slate-300">${reminderDate.toLocaleString('pt-BR')}</td>
            <td class="px-4 py-3 text-slate-300">${relatedLead ? relatedLead.name : '-'}</td>
            <td class="px-4 py-3">
              <span class="text-xs px-2 py-1 rounded-full ${statusClass} bg-slate-700/50">${statusText}</span>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                ${!reminder.reminder_completed ? `
                  <button onclick="completeReminder('${reminder.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-green-400" title="Concluir">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </button>
                ` : ''}
                <button onclick="editReminder('${reminder.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-blue-400" title="Editar">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteReminder('${reminder.__backendId}')" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-red-400" title="Excluir">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterReminders() {
      renderRemindersTable();
    }

    function openReminderModal(reminderId = null, leadId = null) {
      const modal = document.getElementById('reminder-modal');
      const form = document.getElementById('reminder-form');
      const title = document.getElementById('reminder-modal-title');

      form.reset();
      document.getElementById('reminder-id').value = '';

      if (reminderId) {
        const reminder = reminders.find(r => r.__backendId === reminderId);
        if (reminder) {
          title.textContent = 'Editar Lembrete';
          document.getElementById('reminder-id').value = reminder.__backendId;
          document.getElementById('reminder-title').value = reminder.reminder_title;
          document.getElementById('reminder-description').value = reminder.reminder_description || '';
          document.getElementById('reminder-date').value = reminder.reminder_date;
          document.getElementById('reminder-time').value = reminder.reminder_time;
          document.getElementById('reminder-lead').value = reminder.reminder_lead_id || '';
        }
      } else {
        title.textContent = 'Novo Lembrete';
        document.getElementById('reminder-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('reminder-time').value = '09:00';
        if (leadId) {
          document.getElementById('reminder-lead').value = leadId;
        }
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeReminderModal() {
      const modal = document.getElementById('reminder-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('reminder-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const reminderId = document.getElementById('reminder-id').value;
      const btn = document.getElementById('reminder-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      const reminderData = {
        type: 'reminder',
        reminder_title: document.getElementById('reminder-title').value,
        reminder_description: document.getElementById('reminder-description').value,
        reminder_date: document.getElementById('reminder-date').value,
        reminder_time: document.getElementById('reminder-time').value,
        reminder_lead_id: document.getElementById('reminder-lead').value || null,
        reminder_completed: reminderId ? (reminders.find(r => r.__backendId === reminderId)?.reminder_completed || false) : false,
        updated_at: new Date().toISOString()
      };

      let result;
      if (reminderId) {
        const existingReminder = reminders.find(r => r.__backendId === reminderId);
        result = await window.dataSdk.update({
          ...existingReminder,
          ...reminderData
        });
      } else {
        if (allData.length >= 999) {
          showToast('Limite de 999 registros atingido', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar Lembrete';
          return;
        }
        reminderData.created_at = new Date().toISOString();
        result = await window.dataSdk.create(reminderData);
      }

      btn.disabled = false;
      btn.textContent = 'Salvar Lembrete';

      if (result.isOk) {
        showToast(reminderId ? 'Lembrete atualizado!' : 'Lembrete criado!', 'success');
        closeReminderModal();
      } else {
        showToast('Erro ao salvar lembrete', 'error');
      }
    });

    function editReminder(reminderId) {
      openReminderModal(reminderId);
    }

    function deleteReminder(reminderId) {
      const reminder = reminders.find(r => r.__backendId === reminderId);
      if (reminder) {
        document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o lembrete "${reminder.reminder_title}"?`;
        deleteCallback = async () => {
          const btn = document.getElementById('confirm-delete-btn');
          btn.disabled = true;
          btn.textContent = 'Excluindo...';

          const result = await window.dataSdk.delete(reminder);

          btn.disabled = false;
          btn.textContent = 'Excluir';

          if (result.isOk) {
            showToast('Lembrete excluído!', 'success');
            closeDeleteModal();
          } else {
            showToast('Erro ao excluir lembrete', 'error');
          }
        };
        openDeleteModal();
      }
    }

    async function completeReminder(reminderId) {
      const reminder = reminders.find(r => r.__backendId === reminderId);
      if (reminder) {
        const result = await window.dataSdk.update({
          ...reminder,
          reminder_completed: true,
          updated_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('Lembrete concluído!', 'success');
        } else {
          showToast('Erro ao concluir lembrete', 'error');
        }
      }
    }

    function checkReminders() {
      const now = new Date();
      const pending = reminders.filter(r => !r.reminder_completed);

      pending.forEach(reminder => {
        const reminderDate = new Date(reminder.reminder_date + 'T' + reminder.reminder_time);
        const timeDiff = reminderDate - now;
        const minutesDiff = Math.floor(timeDiff / (1000 * 60));

        // Show popup if reminder is within 1 minute of trigger time or overdue
        if (minutesDiff <= 1 && minutesDiff >= -60 && reminder.__backendId !== currentReminderPopup) {
          showReminderPopup(reminder);
          currentReminderPopup = reminder.__backendId;
        }
      });
    }

    function showReminderPopup(reminder) {
      const popup = document.getElementById('reminder-popup');
      const relatedLead = reminder.reminder_lead_id ? leads.find(l => l.__backendId === reminder.reminder_lead_id) : null;

      document.getElementById('popup-title').textContent = reminder.reminder_title;
      document.getElementById('popup-description').textContent = reminder.reminder_description || 'Sem descrição';
      document.getElementById('popup-lead').textContent = relatedLead ? `Lead: ${relatedLead.name}` : '';

      popup.classList.remove('hidden');
      popup.classList.add('flex');

      // Store the reminder ID for completion
      popup.dataset.reminderId = reminder.__backendId;
    }

    function closeReminderPopup() {
      const popup = document.getElementById('reminder-popup');
      popup.classList.add('hidden');
      popup.classList.remove('flex');
      currentReminderPopup = null;
    }

    function markReminderComplete() {
      const popup = document.getElementById('reminder-popup');
      const reminderId = popup.dataset.reminderId;
      if (reminderId) {
        completeReminder(reminderId);
        closeReminderPopup();
      }
    }

    function clearReminders() {
      const completed = reminders.filter(r => r.reminder_completed);
      if (completed.length === 0) {
        showToast('Nenhum lembrete concluído para limpar', 'info');
        return;
      }

      document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir ${completed.length} lembrete(s) concluído(s)?`;
      deleteCallback = async () => {
        const btn = document.getElementById('confirm-delete-btn');
        btn.disabled = true;
        btn.textContent = 'Excluindo...';

        let deleted = 0;
        for (const reminder of completed) {
          const result = await window.dataSdk.delete(reminder);
          if (result.isOk) deleted++;
        }

        btn.disabled = false;
        btn.textContent = 'Excluir';

        if (deleted > 0) {
          showToast(`${deleted} lembrete(s) excluído(s)!`, 'success');
          closeDeleteModal();
        }
      };
      openDeleteModal();
    }

    // Update lead modal to show reminder button when editing
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('lead-id').addEventListener('change', () => {
        const leadId = document.getElementById('lead-id').value;
        const reminderBtn = document.getElementById('add-reminder-btn');
        if (leadId) {
          reminderBtn.style.display = 'flex';
        } else {
          reminderBtn.style.display = 'none';
        }
      });

      document.getElementById('add-reminder-btn').addEventListener('click', () => {
        const leadId = document.getElementById('lead-id').value;
        closeLeadModal();
        openReminderModal(null, leadId);
      });
    });
  </script>
</body>
</html>
